---
import { type CollectionEntry, getCollection } from "astro:content";
import BaseHead from "@components/BaseHead.astro";
import Footer from "@components/Footer.astro";
import FormattedDate from "@components/FormattedDate.astro";
import Header from "@components/Header.astro";
import { PAGE_SIZE } from "../pageSize";

export async function getStaticPaths({
        paginate,
}: { paginate: import("astro").PaginateFunction }) {
        const posts = (await getCollection("cPosts")).sort(
                (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
        );
        const postsByYear = posts.reduce<Record<string, CollectionEntry<"cPosts">[]>>(
                (acc, post) => {
                        const year = post.data.date.getFullYear().toString();
                        acc[year] ??= [];
                        acc[year].push(post);
                        return acc;
                },
                {},
        );

        return Object.entries(postsByYear).flatMap(([year, yearPosts]) =>
                paginate(yearPosts, { pageSize: PAGE_SIZE, params: { year } }),
        );
}

const { page } = Astro.props as {
        page: import("astro").Page<CollectionEntry<"cPosts">> & {
                params: { year: string };
        };
};

const { year } = page.params;
const title =
        page.currentPage === 1
                ? `Archiv ${year}`
                : `Archiv ${year} – Seite ${page.currentPage}`;
---
<!doctype html>
<html lang="de">
        <head>
                <BaseHead title={title} description={`Beiträge aus dem Jahr ${year}`} />
                <style>
                        main {
                                max-width: 960px;
                                margin: 0 auto;
                                padding: 2rem 1rem;
                        }

                        h1 {
                                margin-bottom: 1rem;
                        }

                        .post-list {
                                list-style: none;
                                padding: 0;
                                margin: 0;
                                display: flex;
                                flex-direction: column;
                                gap: 1.25rem;
                        }

                        .post-title {
                                margin: 0 0 0.25rem;
                                font-size: 1.25rem;
                        }

                        .post-title a {
                                color: inherit;
                                text-decoration: none;
                        }

                        .post-title a:hover {
                                color: rgb(var(--accent));
                        }

                        .post-date {
                                margin: 0;
                                color: rgb(var(--gray));
                        }

                        .pagination {
                                display: flex;
                                justify-content: space-between;
                                gap: 1rem;
                                margin: 2rem 0 0;
                        }

                        .pagination a {
                                color: rgb(var(--accent));
                                text-decoration: none;
                        }

                        .pagination a:hover {
                                text-decoration: underline;
                        }
                </style>
        </head>
        <body>
                <Header />
                <main>
                        <h1>{title}</h1>
                        <ul class="post-list">
                                {page.data.map((post) => {
                                        const link = post.data.url ?? `/${post.id}/`;

                                        return (
                                                <li>
                                                        <h2 class="post-title">
                                                                <a href={link}>{post.data.title}</a>
                                                        </h2>
                                                        <p class="post-date">
                                                                <FormattedDate date={post.data.date} />
                                                        </p>
                                                </li>
                                        );
                                })}
                        </ul>
                        <nav class="pagination">
                                <div>{page.url.prev && <a href={page.url.prev}>Neuere Beiträge</a>}</div>
                                <div>{page.url.next && <a href={page.url.next}>Ältere Beiträge</a>}</div>
                        </nav>
                </main>
                <Footer />
        </body>
</html>
